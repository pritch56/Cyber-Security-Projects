<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Password Strength & Exposure Evaluator</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js" defer></script>
  <script defer>
    async function sha1(str) {
      const buf = new TextEncoder("utf-8").encode(str);
      const hashBuffer = await crypto.subtle.digest("SHA-1", buf);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("").toUpperCase();
    }

    function strengthLabel(score) {
      return ["Very weak", "Weak", "Fair", "Good", "Strong"][score] || "Unknown";
    }

    function strengthClass(score) {
      if (score <= 1) return "weak";
      if (score <= 3) return "medium";
      return "strong";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const passwordInput = document.getElementById("password");
      const entropyEl = document.getElementById("entropy-value");
      const strengthEl = document.getElementById("strength-value");
      const feedbackEl = document.getElementById("feedback-value");
      const breachCountEl = document.getElementById("breach-count");
      const breachStatusEl = document.getElementById("breach-status");
      const breachLoader = document.getElementById("breach-loader");

      let latestQuery = 0;

      async function checkBreach(password) {
        if (!password) {
          breachCountEl.textContent = "";
          breachStatusEl.textContent = "";
          breachLoader.style.display = "none";
          return;
        }
        breachLoader.style.display = "block";
        breachCountEl.textContent = "";
        breachStatusEl.textContent = "";
        latestQuery++;
        const queryId = latestQuery;

        const hash = await sha1(password);
        const prefix = hash.slice(0, 5);
        const suffix = hash.slice(5);

        try {
          const response = await fetch("/api/check_pwned", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ prefix, suffix }),
          });
          if (queryId !== latestQuery) return; // outdated response, ignore
          const data = await response.json();
          breachLoader.style.display = "none";
          if (data.error) {
            breachStatusEl.textContent = `Error: ${data.error}`;
            breachStatusEl.className = "weak";
            breachCountEl.textContent = "";
          } else {
            const count = data.count || 0;
            breachCountEl.textContent = count.toLocaleString();
            if (count === 0) {
              breachStatusEl.textContent = "No breaches found";
              breachStatusEl.className = "strong";
            } else if (count < 100) {
              breachStatusEl.textContent = "Breached";
              breachStatusEl.className = "medium";
            } else {
              breachStatusEl.textContent = "Highly breached!";
              breachStatusEl.className = "weak";
            }
          }
        } catch (e) {
          if (queryId !== latestQuery) return;
          breachLoader.style.display = "none";
          breachStatusEl.textContent = `Network error`;
          breachStatusEl.className = "weak";
          breachCountEl.textContent = "";
        }
      }

      function updateResults(password) {
        if (!password) {
          entropyEl.textContent = "";
          strengthEl.textContent = "";
          feedbackEl.textContent = "";
          breachCountEl.textContent = "";
          breachStatusEl.textContent = "";
          breachLoader.style.display = "none";
          return;
        }
        const result = zxcvbn(password);

        // Entropy in bits
        entropyEl.textContent = result.entropy.toFixed(2) + " bits";

        // Strength text colored by score
        strengthEl.textContent = strengthLabel(result.score);
        strengthEl.className = strengthClass(result.score);

        // Feedback warning & suggestions
        let messages = [];
        if(result.feedback.warning) messages.push(result.feedback.warning);
        if(result.feedback.suggestions.length) messages.push(...result.feedback.suggestions);
        feedbackEl.textContent = messages.join(" ") || "Good password";

        checkBreach(password);
      }

      passwordInput.addEventListener("input", e => {
        updateResults(e.target.value);
      });
    });
  </script>
</head>
<body>
  <header>
    <div class="logo" aria-label="Password Strength and Exposure Evaluator">üîí SecureCheck</div>
  </header>

  <main class="container" role="main">
    <section class="hero" aria-label="Hero section">
      <h1>Password Strength &amp; Exposure Evaluator</h1>
      <p>Check your password strength, entropy, dictionary pattern usage, and exposure in real-world breaches with instant feedback.</p>
      <button class="cta" onclick="document.getElementById('password').focus()">Get Started</button>
    </section>

    <section aria-label="Password input form" class="card" role="form">
      <label for="password">Enter your password</label>
      <input 
        type="password" 
        id="password" 
        name="password" 
        autocomplete="new-password" 
        placeholder="Type a password..." 
        aria-describedby="password-help"
        aria-required="true"
        minlength="1"
      />
      <small id="password-help" style="color:#6b7280; font-style: italic; margin-top: 0.25rem; display: block;">
        Your password will not be sent to third parties. Breach check uses a privacy-preserving method.
      </small>
    </section>

    <section aria-label="Password evaluation results" class="results" role="region" aria-live="polite">
      <article class="result-card" aria-label="Password entropy">
        <h3>Entropy</h3>
        <p id="entropy-value" aria-atomic="true"></p>
      </article>
      <article class="result-card" aria-label="Password strength">
        <h3>Strength</h3>
        <p id="strength-value" aria-atomic="true"></p>
      </article>
      <article class="result-card" aria-label="Password feedback">
        <h3>Feedback</h3>
        <p id="feedback-value" aria-atomic="true"></p>
      </article>
      <article class="result-card" aria-label="Password breach exposure">
        <h3>Breach Exposure</h3>
        <div style="display:flex; align-items:center; gap:1rem;">
          <div id="breach-count" style="font-weight:700; font-size:1.3rem;"></div>
          <div class="loader" id="breach-loader" style="display:none;" aria-hidden="true"></div>
        </div>
        <p id="breach-status" aria-atomic="true"></p>
      </article>
    </section>
  </main>

  <footer>
    Made with üîê &nbsp;|&nbsp; Powered by zxcvbn &amp; haveibeenpwned API
  </footer>
</body>
</html>
